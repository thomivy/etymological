name: Yearly Etymology Corpus Refresh

on:
  schedule:
    # Run annually on January 1st at 02:00 UTC (good time for yearly maintenance)
    - cron: '0 2 1 1 *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      sample_size:
        description: 'Number of words to process'
        required: false
        default: '300'
        type: string

jobs:
  refresh-corpus:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to commit root data
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Build etymology corpus
      run: |
        echo "Building etymology corpus..."
        python scripts/build_roots.py --verbose
        
        # Check if file was created successfully
        if [ -f "data/roots.json.gz" ]; then
          FILE_SIZE=$(stat -c%s "data/roots.json.gz" 2>/dev/null || stat -f%z "data/roots.json.gz")
          echo "âœ… Successfully built corpus: data/roots.json.gz (${FILE_SIZE} bytes)"
        else
          echo "âŒ Failed to build corpus file"
          exit 1
        fi
    
    - name: Validate corpus
      run: |
        echo "ðŸ“Š Validating etymology corpus..."
        python -c "import gzip, json; data = json.load(gzip.open('data/roots.json.gz', 'rt')); print(f'Corpus: {len(data)} roots, {sum(len(words) for words in data.values())} relationships')"
    
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet data/roots.json.gz 2>/dev/null; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ No changes detected in etymology corpus"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Changes detected in etymology corpus"
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config user.name "EtymoBot[bot]"
        git config user.email "noreply@github.com"
        
        git add data/roots.json.gz
        git commit -m "Yearly etymology corpus refresh $(date -u +%Y-%m-%d)"
        git push
        
        echo "âœ… Committed and pushed etymology corpus update"
    
    - name: Report completion
      run: |
        if [ "${{ steps.check_changes.outputs.changes }}" = "true" ]; then
          echo "ðŸŽ‰ Etymology corpus refresh completed successfully with updates!"
        else
          echo "âœ… Etymology corpus refresh completed - no updates needed"
        fi
        echo "ðŸ“ˆ Etymology corpus is ready for tweet generation" 